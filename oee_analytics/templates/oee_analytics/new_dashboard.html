{% extends 'base.html' %}
{% load static %}

{% block title %}OEE Dashboard{% endblock %}

{% block content %}
<!-- Top KPI Row - spans full width, ~20-25% height of screen -->
<div class="kpi-row">
    <div class="container-fluid h-100">
        <div class="row h-100 gx-2 gy-0">
            
            <!-- Availability Card -->
            <div class="col-3 kpi-card-col">
                <div class="kpi-card h-100">
                    <div class="kpi-header">
                        <span class="kpi-label">Availability</span>
                    </div>
                    <div class="kpi-main">
                        <div class="kpi-value" id="availability-value">95%</div>
                    </div>
                    <div class="kpi-sparkline-container">
                        <canvas id="availability-sparkline" width="200" height="40"></canvas>
                        <div class="mini-indicators">
                            <span class="mini-indicator left">âˆ‡7</span>
                            <span class="mini-indicator right">2v</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Card -->
            <div class="col-2 kpi-card-col">
                <div class="kpi-card h-100">
                    <div class="kpi-header">
                        <span class="kpi-label">Performance</span>
                    </div>
                    <div class="kpi-main">
                        <div class="kpi-value" id="performance-value">88%</div>
                    </div>
                    <div class="kpi-sparkline-container">
                        <canvas id="performance-sparkline" width="200" height="40"></canvas>
                        <div class="mini-indicators">
                            <span class="mini-indicator right">-1.2</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quality Card -->
            <div class="col-2 kpi-card-col">
                <div class="kpi-card h-100">
                    <div class="kpi-header">
                        <span class="kpi-label">Quality</span>
                    </div>
                    <div class="kpi-main">
                        <div class="kpi-value" id="quality-value">98%</div>
                    </div>
                    <div class="kpi-sparkline-container">
                        <canvas id="quality-sparkline" width="200" height="40"></canvas>
                        <div class="mini-indicators">
                            <span class="mini-indicator right">+0.8</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overall OEE Card -->
            <div class="col-3 kpi-card-col">
                <div class="kpi-card h-100">
                    <div class="kpi-header">
                        <span class="kpi-label">Overall OEE</span>
                    </div>
                    <div class="kpi-main">
                        <div class="kpi-value oee-main" id="oee-value">82%</div>
                    </div>
                    <div class="kpi-sparkline-container">
                        <canvas id="oee-sparkline" width="200" height="40"></canvas>
                        <div class="mini-indicators">
                            <span class="mini-indicator right">+1.5</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Time Window / Trend Card (narrower) -->
            <div class="col-2 trend-card-col">
                <div class="trend-card h-100">
                    <div class="trend-header">
                        <span class="trend-label">4 Hours</span>
                    </div>
                    <div class="trend-chart">
                        <canvas id="trend-chart" width="120" height="80"></canvas>
                    </div>
                    <div class="trend-footer">
                        <span class="trend-change positive">0.8%</span>
                        <span class="trend-tag">Reepara</span>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Middle Section - Occupies 45-50% of dashboard height -->
<div class="middle-section">
    <div class="container-fluid h-100">
        <div class="row h-100 gx-2 gy-0">
            
            <!-- Left Panel: Planned vs Actual (70% width) -->
            <div class="col-8 left-panel-col">
                <div class="left-panel h-100">
                    
                    <!-- Line Chart Area (65% of panel height) -->
                    <div class="chart-area" style="height: 65% !important; margin-bottom: 0.5rem !important;">
                        <div class="chart-header">
                            <h5 class="chart-title">PLANNED vs ACTUAL</h5>
                            <div class="chart-annotations">
                                <span class="annotation-time">1.15 min</span>
                                <span class="annotation-highlight">0.5 m</span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="planned-actual-chart" width="800" height="300"></canvas>
                        </div>
                    </div>
                    
                    <!-- Metric Strip (35% of panel height) -->
                    <div class="metric-strip" style="height: 35% !important; margin-top: auto !important;">
                        <div class="row h-100 g-2">
                            
                            <!-- Block 1: Planned vs Actual Values -->
                            <div class="col-3">
                                <div class="metric-block h-100">
                                    <div class="metric-values">
                                        <div class="planned-value">
                                            <span class="value-label">Planned</span>
                                            <span class="value-number">156</span>
                                        </div>
                                        <div class="actual-value">
                                            <span class="value-label">Current</span>
                                            <span class="value-number">142</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Block 2: Current Rate -->
                            <div class="col-3">
                                <div class="metric-block h-100">
                                    <div class="rate-display">
                                        <span class="rate-label">Current Rate</span>
                                        <span class="rate-value">4.2</span>
                                        <span class="rate-unit">units/min</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Block 3: Cycle Time vs Target -->
                            <div class="col-3">
                                <div class="metric-block h-100">
                                    <div class="cycle-time-display">
                                        <span class="cycle-label">Cycle Time vs Target</span>
                                        <div class="cycle-progress">
                                            <div class="progress-bar-container">
                                                <div class="progress-bar" style="width: 78%"></div>
                                            </div>
                                            <span class="cycle-annotation">14.3s / 18.5s</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Block 4: Shift Goal -->
                            <div class="col-3">
                                <div class="metric-block h-100">
                                    <div class="shift-goal-display">
                                        <span class="goal-label">Shift Goal</span>
                                        <div class="goal-progress">
                                            <div class="progress-bar-container">
                                                <div class="progress-bar goal-bar" style="width: 89%"></div>
                                            </div>
                                            <span class="goal-annotation">267 / 300</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- Right Panel: Status Information (30% width) -->
            <div class="col-4 right-panel-col">
                <div class="right-panel h-100">
                    
                    <!-- Active Fault Overlay (top 50%) -->
                    <div class="fault-overlay" style="height: 40% !important; margin-bottom: 0.1rem !important;">
                        <div class="fault-header">
                            <h6 class="fault-title">ACTIVE FAULT OVERLAY</h6>
                        </div>
                        <div class="fault-table">
                            <!-- Table Header Row -->
                            <div class="fault-header-row">
                                <span class="header-asset">Asset ID</span>
                                <span class="header-fault">TOP LINE</span>
                                <span class="header-mttr">MTTR</span>
                                <span class="header-mtbf">MTBF</span>
                            </div>
                            <!-- Data Rows -->
                            <div class="fault-row">
                                <span class="asset-id">A1a</span>
                                <span class="fault-type">Maintenance</span>
                                <span class="mttr-value">0.74</span>
                                <span class="mtbf-value">5.71</span>
                            </div>
                            <div class="fault-row">
                                <span class="asset-id">MTSE</span>
                                <span class="fault-type">MJ-SS-96</span>
                                <span class="mttr-value">0.58</span>
                                <span class="mtbf-value">5.43</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Last Downtime Event (bottom 50%) -->
                    <div class="downtime-event" style="height: 40% !important; margin-top: 0.1rem !important;">
                        <div class="downtime-header">
                            <h6 class="downtime-title">LAST DOWNTIME EVENT</h6>
                        </div>
                        <div class="downtime-metrics">
                            <div class="metrics-row">
                                <div class="metric-item">
                                    <span class="metric-label">Type</span>
                                    <span class="metric-value highlight">Setup</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">MTTR</span>
                                    <span class="metric-value">2.3m</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">MTBF</span>
                                    <span class="metric-value">18.7m</span>
                                </div>
                            </div>
                        </div>
                        <div class="downtime-chart">
                            <div class="chart-label">Event Timeline</div>
                            <canvas id="downtime-micro-chart" width="180" height="50"></canvas>
                        </div>
                        <div class="runtime-bar">
                            <div class="runtime-container">
                                <div class="runtime-label">Run's Time Downtime</div>
                                <div class="runtime-progress">
                                    <div class="runtime-bar-fill" style="width: 85%"></div>
                                    <span class="runtime-percentage">85%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            
        </div>
    </div>
</div>

<!-- Bottom Section: Machine Rail -->
<div class="machine-rail-section">
    <div class="container-fluid h-100">
        <div class="row h-100 align-items-center g-0 mx-0">
            
            <!-- Machine 1 -->
            <div class="col machine-segment">
                <div class="machine-node">
                    <div class="node-circle operational" data-machine="1"></div>
                    <div class="node-label">MACHINE 1</div>
                </div>
                <!-- Connection Line to Machine 2 -->
                <div class="connection-line"></div>
            </div>
            
            <!-- Machine 2 -->
            <div class="col machine-segment">
                <div class="machine-node">
                    <div class="node-circle operational" data-machine="2"></div>
                    <div class="node-label">MACHINE 2</div>
                </div>
                <!-- Connection Line to Machine 3 -->
                <div class="connection-line"></div>
            </div>
            
            <!-- Machine 3 -->
            <div class="col machine-segment">
                <div class="machine-node">
                    <div class="node-circle operational" data-machine="3"></div>
                    <div class="node-label">MACHINE 3</div>
                </div>
                <!-- Connection Line to Machine 4 -->
                <div class="connection-line blocked-connection"></div>
            </div>
            
            <!-- Machine 4 (Blocked) -->
            <div class="col machine-segment">
                <div class="machine-node">
                    <div class="node-circle blocked" data-machine="4"></div>
                    <div class="node-label blocked-label">BLOCKED</div>
                    
                    <!-- Fault Popup Overlay -->
                    <div class="fault-popup">
                        <div class="popup-content">
                            <div class="fault-title">HPU Failure</div>
                            <div class="fault-severity">
                                <span class="severity-label">Severity</span>
                                <span class="severity-value high">High</span>
                            </div>
                            <div class="fault-start-time">
                                <span class="time-label">Start Time</span>
                                <span class="time-value">10:34:01</span>
                            </div>
                            <div class="downtime-timer">07:34</div>
                        </div>
                    </div>
                </div>
                <!-- Connection Line to Machine 5 -->
                <div class="connection-line blocked-connection"></div>
            </div>
            
            <!-- Machine 5 -->
            <div class="col machine-segment">
                <div class="machine-node">
                    <div class="node-circle operational" data-machine="5"></div>
                    <div class="node-label">MACHINE 5</div>
                </div>
            </div>
            
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
/* Typewriter animation for diagnostics */
@keyframes typewriter {
    0% { 
        width: 0; 
        opacity: 0;
    }
    1% {
        opacity: 1;
    }
    100% { 
        width: 100%; 
        opacity: 1;
    }
}

.typewriter-line {
    overflow: hidden;
    white-space: nowrap;
    width: 0;
    animation: typewriter 0.8s ease-out forwards;
}
.kpi-value {
    font-size: 4.5rem !important;
    font-weight: 700 !important;
    color: #2d3748 !important;
    line-height: 1 !important;
}

.kpi-value.oee-main {
    color: #007bff !important;
    font-size: 4.75rem !important;
}

/* Middle Section Styles */
.middle-section {
    height: 47vh; /* 45-50% of viewport height */
    min-height: 400px;
    padding: 1rem;
    background: #f8f9fa;
}

/* Left Panel - Planned vs Actual (70% width) */
.left-panel-col {
    flex: 0 0 66.66667%; /* Use Bootstrap col-8 exact percentage */
    max-width: 66.66667%;
}

.left-panel {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
}

/* Chart Area (60-65% of panel height) - Scaled down */
.chart-area {
    height: 50% !important;
    margin-bottom: 0.5rem !important;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.chart-title {
    font-size: 1rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0;
}

.chart-annotations {
    display: flex;
    gap: 1rem;
}

.annotation-time {
    font-size: 0.875rem;
    color: #28a745;
    font-weight: 500;
}

.annotation-highlight {
    font-size: 0.875rem;
    color: #dc3545;
    font-weight: 600;
}

.chart-container {
    height: calc(100% - 60px);
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Metric Strip (35-40% of panel height) - Scaled down */
.metric-strip {
    height: 30% !important;
    margin-top: auto !important;
}

.metric-block {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 0.5rem !important;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
}

/* Planned vs Actual Values Block */
.metric-values {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.planned-value, .actual-value {
    display: flex;
    flex-direction: column;
}

.value-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: #6c757d;
    text-transform: uppercase;
}

.value-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #2d3748;
}

/* Current Rate Block */
.rate-display {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.rate-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: #6c757d;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
}

.rate-value {
    font-size: 2rem;
    font-weight: 700;
    color: #007bff;
}

.rate-unit {
    font-size: 0.75rem;
    color: #6c757d;
}

/* Cycle Time and Shift Goal Progress Blocks */
.cycle-time-display, .shift-goal-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
}

.cycle-label, .goal-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: #6c757d;
    text-transform: uppercase;
    margin-bottom: 0.75rem;
}

.cycle-progress, .goal-progress {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.progress-bar-container {
    width: 100%;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.progress-bar {
    height: 100%;
    background: #28a745;
    transition: width 0.3s ease;
}

.progress-bar.goal-bar {
    background: #007bff;
}

.cycle-annotation, .goal-annotation {
    font-size: 0.75rem;
    font-weight: 600;
    color: #2d3748;
}

/* Right Panel - Status Information (30% width) */
.right-panel-col {
    flex: 0 0 33.33333%; /* Use Bootstrap col-4 exact percentage */
    max-width: 33.33333%;
}

.right-panel {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
}

/* Active Fault Overlay (top 50%) - Scaled down */
.fault-overlay {
    height: 40% !important;
    margin-bottom: 0.5rem !important;
}

.fault-header {
    margin-bottom: 1rem;
}

.fault-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0 0 0.5rem 0;
}

.fault-legend {
    display: flex;
    gap: 1rem;
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
}

.legend-item {
    flex: 1;
    text-align: center;
}

.fault-table {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.fault-header-row {
    display: grid;
    grid-template-columns: 1fr 2fr 1fr 1fr;
    gap: 0.5rem;
    padding: 0.3rem 0.5rem;
    background: #e9ecef;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    color: #495057;
    text-transform: uppercase;
    border-bottom: 2px solid #dee2e6;
}

.fault-row {
    display: grid;
    grid-template-columns: 1fr 2fr 1fr 1fr;
    gap: 0.5rem;
    padding: 0.4rem 0.5rem;
    background: #f8f9fa;
    border-radius: 4px;
    font-size: 0.8rem;
    border-left: 3px solid #007bff;
}

.asset-id {
    font-weight: 600;
    color: #007bff;
}

.fault-type {
    color: #2d3748;
}

.mttr-value, .mtbf-value {
    text-align: center;
    font-weight: 500;
    color: #28a745;
}

/* Last Downtime Event (bottom 50%) - Scaled down */
.downtime-event {
    height: 40% !important;
    margin-top: auto !important;
}

.downtime-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0 0 1rem 0;
}

.downtime-metrics {
    margin-bottom: 0.75rem;
}

.metrics-row {
    display: flex;
    gap: 0.5rem;
    background: #f8f9fa;
    padding: 0.5rem;
    border-radius: 6px;
    border: 1px solid #e9ecef;
}

.metric-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.metric-label {
    font-size: 0.65rem;
    color: #6c757d;
    text-transform: uppercase;
    margin-bottom: 0.25rem;
    font-weight: 500;
}

.metric-value {
    font-size: 0.85rem;
    font-weight: 600;
    color: #2d3748;
}

.metric-value.highlight {
    color: #dc3545;
    font-weight: 700;
}

.downtime-chart {
    margin-bottom: 0.75rem;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.chart-label {
    font-size: 0.65rem;
    color: #6c757d;
    text-transform: uppercase;
    margin-bottom: 0.25rem;
    font-weight: 500;
}

.runtime-bar {
    margin-top: auto;
}

.runtime-container {
    width: 100%;
}

.runtime-label {
    font-size: 0.75rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
}

.runtime-progress {
    width: 100%;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
    margin-bottom: 0.25rem;
}

.runtime-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffc107 0%, #ff9500 100%);
    transition: width 0.3s ease;
    border-radius: 4px;
}

.runtime-percentage {
    font-size: 0.7rem;
    color: #6c757d;
    font-weight: 500;
    text-align: right;
    display: block;
}

/* Responsive Design for Middle Section */
@media (max-width: 992px) {
    .middle-section {
        height: auto;
        min-height: auto;
        padding: 0.75rem;
    }
    
    .left-panel-col {
        flex: 0 0 100%;
        margin-bottom: 1rem;
    }
    
    .right-panel-col {
        flex: 0 0 100%;
    }
    
    .chart-area {
        height: 300px;
    }
    
    .metric-strip {
        height: auto;
    }
    
    .fault-overlay, .downtime-event {
        height: auto;
        margin-bottom: 1rem;
    }
}

/* MACHINE RAIL BOTTOM SECTION */
.machine-rail-section {
    height: 18vh !important; /* 15-20% of viewport height */
    min-height: 120px !important;
    max-height: 180px !important;
    padding: 1rem !important; /* Match top and middle section padding */
    margin: 16rem 0 0 0 !important; /* Move machine rail even lower */
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%) !important;
    border-top: 3px solid #0d6efd !important;
    position: relative !important;
    overflow: visible !important;
}

/* Ensure body height is properly managed */
body {
    overflow-x: auto !important;
    overflow-y: auto !important;
    height: auto !important;
    min-height: 100vh !important;
    padding-bottom: 1rem !important; /* Small padding to prevent cut-off */
}

/* OVERRIDE EXTERNAL CSS - Fix column widths */
.kpi-row .kpi-card-col {
    flex: unset !important;
    max-width: unset !important;
}

.kpi-row .trend-card-col {
    flex: unset !important;
    max-width: unset !important;
}

/* ENSURE CONSISTENT ALIGNMENT ACROSS ALL SECTIONS */
.kpi-row,
.middle-section,
.machine-rail-section {
    padding-left: 1rem !important;
    padding-right: 1rem !important;
}

/* Remove Bootstrap container padding */
.kpi-row .container-fluid,
.middle-section .container-fluid,
.machine-rail-section .container-fluid {
    padding-left: 0 !important;
    padding-right: 0 !important;
}

/* Force proper viewport height distribution - Balanced for 100% zoom */
.kpi-row {
    height: 22vh !important;
    min-height: 170px !important;
    max-height: 220px !important;
    margin-top: 0 !important; /* Remove default spacing */
    padding-top: 0.5rem !important; /* Minimal padding from header */
}

.middle-section {
    height: 23vh !important; /* 50% reduction from original 47vh */
    min-height: 200px !important; /* 50% reduction from original 400px */
    max-height: 200px !important; /* 50% reduction for balanced layout */
    background: #f8f9fa !important; /* Back to original light gray */
    margin-top: 1rem !important; /* Moderate spacing */
}

/* Ensure main content areas don't exceed viewport */
.content-area {
    max-height: 100vh !important;
    overflow-y: auto !important;
}

/* Force container to respect height limits */
.container-fluid {
    max-height: 100% !important;
}

/* Ensure all sections are visible */
html, body {
    scroll-behavior: smooth !important;
}

/* CRITICAL: Scale down CARD CONTAINERS only, keep content original size */
.middle-section .left-panel {
    padding: 0.75rem !important; /* Slightly smaller padding */
    max-height: 86% !important; /* Increase card height by another 20% (72% + 14.4% = 86.4%) */
    overflow: hidden !important; /* Prevent content overflow */
}

.middle-section .right-panel {
    padding: 0.75rem !important; /* Slightly smaller padding */
    max-height: 86% !important; /* Increase card height by another 20% (72% + 14.4% = 86.4%) */
    overflow: hidden !important; /* Prevent content overflow */
}

/* Keep original content proportions inside smaller cards */
.middle-section .chart-area {
    height: 60% !important; /* Original proportion within smaller card */
    margin-bottom: 0.5rem !important; /* Original spacing */
}

.middle-section .metric-strip {
    height: 40% !important; /* Original proportion within smaller card */
    margin-top: auto !important;
}

.middle-section .fault-overlay {
    height: 50% !important; /* Original proportion within smaller card */
    margin-bottom: 0.15rem !important; /* Reduced spacing by 70% (0.5rem - 0.35rem) */
}

.middle-section .downtime-event {
    height: 50% !important; /* Original proportion within smaller card */
    margin-top: 0 !important; /* Remove auto margin to move up by 30% */
}

.middle-section .metric-block {
    padding: 0.5rem !important; /* Original padding */
}

/* Keep original text sizes */
.middle-section .chart-title,
.middle-section .fault-title, 
.middle-section .downtime-title {
    font-size: inherit !important; /* Keep original font sizes */
}

/* MACHINE RAIL COMPONENTS */
.machine-segment {
    flex: 1 !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    height: 100% !important;
}

.machine-node {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    position: relative !important;
    height: 100% !important;
    justify-content: center !important;
}

/* NODE CIRCLES */
.node-circle {
    width: 60px !important;
    height: 60px !important;
    border-radius: 50% !important;
    border: 3px solid transparent !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    margin-bottom: 0.75rem !important;
    position: relative !important;
    transition: all 0.3s ease !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
    z-index: 2 !important; /* Above connection lines */
}

.node-circle.operational {
    background: radial-gradient(circle, #28a745 0%, #20c997 100%) !important;
    border-color: #28a745 !important;
    animation: pulse-green 2s infinite !important;
}

.node-circle.blocked {
    background: radial-gradient(circle, #dc3545 0%, #e74c3c 100%) !important;
    border-color: #dc3545 !important;
    animation: pulse-red 1.5s infinite !important;
}

@keyframes pulse-green {
    0%, 100% { 
        box-shadow: 0 4px 12px rgba(0,0,0,0.3), 0 0 0 0 rgba(40, 167, 69, 0.7);
    }
    50% { 
        box-shadow: 0 4px 12px rgba(0,0,0,0.3), 0 0 0 8px rgba(40, 167, 69, 0);
    }
}

@keyframes pulse-red {
    0%, 100% { 
        box-shadow: 0 4px 12px rgba(0,0,0,0.3), 0 0 0 0 rgba(220, 53, 69, 0.7);
    }
    50% { 
        box-shadow: 0 4px 12px rgba(0,0,0,0.3), 0 0 0 10px rgba(220, 53, 69, 0);
    }
}

/* NODE LABELS */
.node-label {
    color: #ffffff !important;
    font-size: 0.75rem !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
    text-align: center !important;
    margin-top: auto !important;
}

.node-label.blocked-label {
    color: #ff6b6b !important;
    font-weight: 700 !important;
    animation: blink 1s infinite !important;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.6; }
}

/* CONNECTION LINES BETWEEN MACHINES */
.connection-line {
    position: absolute !important;
    top: 30px !important; /* Position at circle level (60px circle / 2 = 30px) */
    right: -50% !important;
    width: 100% !important;
    height: 1px !important; /* Razor thin line */
    z-index: 0 !important; /* Behind circles */
    pointer-events: none !important;
}

.connection-line:not(.blocked-connection) {
    background: linear-gradient(90deg, #28a745 0%, #20c997 50%, #28a745 100%) !important;
    box-shadow: 0 0 8px rgba(40, 167, 69, 0.5) !important;
    animation: flow-active 2s infinite !important;
}

.connection-line.blocked-connection {
    background: linear-gradient(90deg, #dc3545 0%, #e74c3c 50%, #dc3545 100%) !important;
    box-shadow: 0 0 8px rgba(220, 53, 69, 0.6) !important;
    animation: flow-blocked 1s infinite !important;
}

@keyframes flow-active {
    0%, 100% {
        opacity: 0.8;
        box-shadow: 0 0 8px rgba(40, 167, 69, 0.5);
    }
    50% {
        opacity: 1;
        box-shadow: 0 0 12px rgba(40, 167, 69, 0.8);
    }
}

@keyframes flow-blocked {
    0%, 100% {
        opacity: 0.6;
        box-shadow: 0 0 8px rgba(220, 53, 69, 0.6);
    }
    50% {
        opacity: 1;
        box-shadow: 0 0 15px rgba(220, 53, 69, 0.9);
    }
}

/* Adjust machine segment to accommodate connection lines */
.machine-segment {
    position: relative !important;
}

.machine-segment:last-child .connection-line {
    display: none !important; /* Hide connection line on last machine */
}

/* FAULT POPUP OVERLAY */
.fault-popup {
    position: absolute !important;
    bottom: 100% !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    margin-bottom: 1rem !important;
    z-index: 1000 !important;
    animation: fadeInUp 0.3s ease !important;
}

.popup-content {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important;
    border: 2px solid #e74c3c !important;
    border-radius: 12px !important;
    padding: 1rem !important;
    width: 200px !important;
    box-shadow: 0 8px 25px rgba(0,0,0,0.4) !important;
    position: relative !important;
}

.popup-content::after {
    content: '' !important;
    position: absolute !important;
    top: 100% !important;
    left: 50% !important;
    margin-left: -8px !important;
    border: 8px solid transparent !important;
    border-top-color: #e74c3c !important;
}

.fault-title {
    color: #ffffff !important;
    font-size: 0.9rem !important;
    font-weight: 700 !important;
    margin-bottom: 0.5rem !important;
    text-align: left !important;
}

.fault-severity {
    display: flex !important;
    justify-content: space-between !important;
    margin-bottom: 0.4rem !important;
}

.severity-label, .time-label {
    color: #bdc3c7 !important;
    font-size: 0.7rem !important;
    font-weight: 500 !important;
}

.severity-value {
    font-size: 0.7rem !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
}

.severity-value.high {
    color: #e74c3c !important;
}

.fault-start-time {
    display: flex !important;
    justify-content: space-between !important;
    margin-bottom: 0.75rem !important;
}

.time-value {
    color: #ffffff !important;
    font-size: 0.7rem !important;
    font-weight: 600 !important;
    font-family: 'Courier New', monospace !important;
}

.downtime-timer {
    color: #e74c3c !important;
    font-size: 1.4rem !important;
    font-weight: 700 !important;
    text-align: center !important;
    font-family: 'Courier New', monospace !important;
    background: rgba(231, 76, 60, 0.1) !important;
    border-radius: 6px !important;
    padding: 0.5rem !important;
    border: 1px solid #e74c3c !important;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}
</style>

<script>
// Initialize dashboard when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeKPIRow();
    initializeMiddleSection();
    initializeMachineRail();
    startDataUpdates();
});

// Initialize KPI row components
function initializeKPIRow() {
    initializeSparklines();
    initializeTrendChart();
    animateKPIValues();
}

// Initialize sparklines for each KPI card
function initializeSparklines() {
    const sparklineData = {
        availability: [88, 90, 92, 89, 93, 91, 92.5],
        performance: [92, 88, 90, 87, 89, 90, 89.1],
        quality: [94, 96, 95, 97, 95, 96, 95.8],
        oee: [82, 84, 86, 83, 87, 85, 85.3]
    };

    Object.keys(sparklineData).forEach(metric => {
        drawSparkline(metric + '-sparkline', sparklineData[metric]);
    });
}

// Draw sparkline on canvas
function drawSparkline(canvasId, data) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // Clear canvas
    ctx.clearRect(0, 0, width, height);
    
    // Calculate dimensions
    const padding = 4;
    const chartWidth = width - (padding * 2);
    const chartHeight = height - (padding * 2);
    
    // Find min/max for scaling
    const min = Math.min(...data);
    const max = Math.max(...data);
    const range = max - min || 1;
    
    // Calculate points
    const points = data.map((value, index) => ({
        x: padding + (index * chartWidth / (data.length - 1)),
        y: padding + chartHeight - ((value - min) / range * chartHeight)
    }));
    
    // Draw line
    ctx.strokeStyle = '#007bff';
    ctx.lineWidth = 2;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    
    ctx.beginPath();
    ctx.moveTo(points[0].x, points[0].y);
    
    for (let i = 1; i < points.length; i++) {
        ctx.lineTo(points[i].x, points[i].y);
    }
    
    ctx.stroke();
    
    // Draw points
    ctx.fillStyle = '#007bff';
    points.forEach(point => {
        ctx.beginPath();
        ctx.arc(point.x, point.y, 2, 0, 2 * Math.PI);
        ctx.fill();
    });
}

// Initialize trend chart
function initializeTrendChart() {
    const canvas = document.getElementById('trend-chart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // Sample 24h trend data
    const trendData = [82, 84, 83, 85, 87, 86, 88, 85, 87, 86, 85, 85.3];
    
    // Clear canvas
    ctx.clearRect(0, 0, width, height);
    
    // Calculate dimensions
    const padding = 8;
    const chartWidth = width - (padding * 2);
    const chartHeight = height - (padding * 2);
    
    // Find min/max for scaling
    const min = Math.min(...trendData);
    const max = Math.max(...trendData);
    const range = max - min || 1;
    
    // Calculate points
    const points = trendData.map((value, index) => ({
        x: padding + (index * chartWidth / (trendData.length - 1)),
        y: padding + chartHeight - ((value - min) / range * chartHeight)
    }));
    
    // Draw area fill
    ctx.fillStyle = 'rgba(40, 167, 69, 0.1)';
    ctx.beginPath();
    ctx.moveTo(points[0].x, height - padding);
    points.forEach(point => ctx.lineTo(point.x, point.y));
    ctx.lineTo(points[points.length - 1].x, height - padding);
    ctx.closePath();
    ctx.fill();
    
    // Draw line
    ctx.strokeStyle = '#28a745';
    ctx.lineWidth = 2;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    
    ctx.beginPath();
    ctx.moveTo(points[0].x, points[0].y);
    points.forEach(point => ctx.lineTo(point.x, point.y));
    ctx.stroke();
}

// Animate KPI values on load
function animateKPIValues() {
    const kpiElements = document.querySelectorAll('.kpi-value');
    
    kpiElements.forEach((element, index) => {
        setTimeout(() => {
            element.style.transform = 'scale(1.05)';
            element.style.transition = 'transform 0.3s ease';
            
            setTimeout(() => {
                element.style.transform = 'scale(1)';
            }, 300);
        }, index * 100);
    });
}

// Start periodic data updates
function startDataUpdates() {
    // Update every 5 seconds
    setInterval(() => {
        updateKPIData();
    }, 5000);
}

// Update KPI data from API
function updateKPIData() {
    fetch('/api/current-metrics/')
        .then(response => response.json())
        .then(data => {
            // Update availability
            const availabilityEl = document.getElementById('availability-value');
            if (availabilityEl && data.availability) {
                availabilityEl.textContent = data.availability.toFixed(1) + '%';
            }
            
            // Update performance
            const performanceEl = document.getElementById('performance-value');
            if (performanceEl && data.performance) {
                performanceEl.textContent = data.performance.toFixed(1) + '%';
            }
            
            // Update quality
            const qualityEl = document.getElementById('quality-value');
            if (qualityEl && data.quality) {
                qualityEl.textContent = data.quality.toFixed(1) + '%';
            }
            
            // Update OEE
            const oeeEl = document.getElementById('oee-value');
            if (oeeEl && data.oee) {
                oeeEl.textContent = data.oee.toFixed(1) + '%';
            }
        })
        .catch(error => {
            console.log('KPI update failed:', error);
        });
}

// Initialize middle section components
function initializeMiddleSection() {
    initializePlannedActualChart();
    initializeDowntimeMicroChart();
}

// Initialize Planned vs Actual line chart
function initializePlannedActualChart() {
    const canvas = document.getElementById('planned-actual-chart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // Clear canvas
    ctx.clearRect(0, 0, width, height);
    
    // Sample data for planned vs actual
    const timePoints = ['0:30', '0:35', '0:40', '0:45', '0:50'];
    const plannedData = [120, 125, 130, 135, 140];
    const actualData = [118, 122, 128, 132, 142];
    const projectedData = [140, 144, 148]; // Future projection
    
    // Chart dimensions
    const padding = 60;
    const chartWidth = width - (padding * 2);
    const chartHeight = height - (padding * 2);
    
    // Find min/max for scaling
    const allData = [...plannedData, ...actualData, ...projectedData];
    const min = Math.min(...allData) - 10;
    const max = Math.max(...allData) + 10;
    const range = max - min;
    
    // Helper function to get point coordinates
    function getPoint(index, value, totalPoints) {
        const x = padding + (index * chartWidth / (totalPoints - 1));
        const y = padding + chartHeight - ((value - min) / range * chartHeight);
        return {x, y};
    }
    
    // Draw grid lines
    ctx.strokeStyle = '#e9ecef';
    ctx.lineWidth = 1;
    
    // Vertical grid lines
    for (let i = 0; i < timePoints.length; i++) {
        const x = padding + (i * chartWidth / (timePoints.length - 1));
        ctx.beginPath();
        ctx.moveTo(x, padding);
        ctx.lineTo(x, height - padding);
        ctx.stroke();
    }
    
    // Horizontal grid lines
    for (let i = 0; i <= 5; i++) {
        const y = padding + (i * chartHeight / 5);
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
        ctx.stroke();
    }
    
    // Draw planned line (green)
    ctx.strokeStyle = '#28a745';
    ctx.lineWidth = 3;
    ctx.beginPath();
    
    for (let i = 0; i < plannedData.length; i++) {
        const point = getPoint(i, plannedData[i], plannedData.length);
        if (i === 0) {
            ctx.moveTo(point.x, point.y);
        } else {
            ctx.lineTo(point.x, point.y);
        }
    }
    ctx.stroke();
    
    // Draw actual line (blue)
    ctx.strokeStyle = '#007bff';
    ctx.lineWidth = 3;
    ctx.beginPath();
    
    for (let i = 0; i < actualData.length; i++) {
        const point = getPoint(i, actualData[i], actualData.length);
        if (i === 0) {
            ctx.moveTo(point.x, point.y);
        } else {
            ctx.lineTo(point.x, point.y);
        }
    }
    ctx.stroke();
    
    // Draw projected line (dotted, orange)
    ctx.strokeStyle = '#ffc107';
    ctx.lineWidth = 2;
    ctx.setLineDash([5, 5]);
    ctx.beginPath();
    
    // Start from last actual point
    const lastActualPoint = getPoint(actualData.length - 1, actualData[actualData.length - 1], actualData.length);
    ctx.moveTo(lastActualPoint.x, lastActualPoint.y);
    
    for (let i = 0; i < projectedData.length; i++) {
        const point = getPoint(actualData.length + i, projectedData[i], actualData.length + projectedData.length - 1);
        ctx.lineTo(point.x, point.y);
    }
    ctx.stroke();
    ctx.setLineDash([]); // Reset line dash
    
    // Add highlighted point (0.5 m annotation)
    const highlightPoint = getPoint(2, actualData[2], actualData.length);
    ctx.fillStyle = '#dc3545';
    ctx.beginPath();
    ctx.arc(highlightPoint.x, highlightPoint.y, 6, 0, 2 * Math.PI);
    ctx.fill();
    
    // Draw axes
    ctx.strokeStyle = '#6c757d';
    ctx.lineWidth = 2;
    
    // X-axis
    ctx.beginPath();
    ctx.moveTo(padding, height - padding);
    ctx.lineTo(width - padding, height - padding);
    ctx.stroke();
    
    // Y-axis
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, height - padding);
    ctx.stroke();
    
    // Add X-axis time labels
    ctx.fillStyle = '#6c757d';
    ctx.font = '12px system-ui';
    ctx.textAlign = 'center';
    
    for (let i = 0; i < timePoints.length; i++) {
        const x = padding + (i * chartWidth / (timePoints.length - 1));
        ctx.fillText(timePoints[i], x, height - padding + 20);
    }
    
    // Add Y-axis value labels
    ctx.textAlign = 'right';
    ctx.font = '11px system-ui';
    
    for (let i = 0; i <= 5; i++) {
        const y = padding + (i * chartHeight / 5);
        const value = Math.round(max - (i * range / 5));
        ctx.fillText(value.toString(), padding - 10, y + 4);
    }
    
    // Add axis titles
    ctx.save();
    ctx.translate(15, height / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.textAlign = 'center';
    ctx.font = 'bold 11px system-ui';
    ctx.fillStyle = '#495057';
    ctx.fillText('Units Produced', 0, 0);
    ctx.restore();
    
    // X-axis title
    ctx.textAlign = 'center';
    ctx.font = 'bold 11px system-ui';
    ctx.fillStyle = '#495057';
    ctx.fillText('Time', width / 2, height - 5);
}

// Initialize downtime micro chart
function initializeDowntimeMicroChart() {
    const canvas = document.getElementById('downtime-micro-chart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // Clear canvas
    ctx.clearRect(0, 0, width, height);
    
    // Sample downtime data (mini bar chart)
    const downtimeData = [15, 8, 12, 20, 5, 18, 10];
    const padding = 10;
    const chartWidth = width - (padding * 2);
    const chartHeight = height - (padding * 2);
    
    const barWidth = chartWidth / downtimeData.length;
    const maxValue = Math.max(...downtimeData);
    
    // Draw bars
    for (let i = 0; i < downtimeData.length; i++) {
        const barHeight = (downtimeData[i] / maxValue) * chartHeight;
        const x = padding + (i * barWidth);
        const y = height - padding - barHeight;
        
        // Alternate colors
        ctx.fillStyle = i % 2 === 0 ? '#007bff' : '#28a745';
        ctx.fillRect(x + 2, y, barWidth - 4, barHeight);
    }
}

// Initialize machine rail
function initializeMachineRail() {
    // Start downtime timer
    startDowntimeTimer();
    
    // Add click handlers for machine nodes
    document.querySelectorAll('.node-circle').forEach(circle => {
        circle.addEventListener('click', function() {
            const machineId = this.getAttribute('data-machine');
            console.log(`Machine ${machineId} clicked`);
            // Future: Show machine details modal
        });
    });
}

// Start and update downtime timer
function startDowntimeTimer() {
    const timerElement = document.querySelector('.downtime-timer');
    if (!timerElement) return;
    
    // Initial time (7 hours 34 minutes from fault start)
    let totalMinutes = 7 * 60 + 34;
    
    function updateTimer() {
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        timerElement.textContent = formattedTime;
        totalMinutes++; // Increment every minute
    }
    
    // Update immediately
    updateTimer();
    
    // Update every minute (60000ms)
    setInterval(updateTimer, 60000);
}
</script>
{% endblock %}