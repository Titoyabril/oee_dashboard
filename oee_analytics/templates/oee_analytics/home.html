{% extends 'base.html' %}
{% load static %}

{% block title %}Home - OEE Performance Hub{% endblock %}

{% block banner %}
<div class="hero-banner bg-gradient-primary text-white py-5">
    <div class="container-fluid">
        <div class="row align-items-center">
            <!-- OEE Score Summary -->
            <div class="col-lg-4">
                <div class="oee-summary">
                    <h2 class="fw-bold mb-3">Current Shift Performance</h2>
                    <div class="d-flex align-items-center mb-3">
                        <div class="oee-main-score me-4">
                            <div class="display-2 fw-bold" id="current-oee">85.3</div>
                            <div class="small">OEE Score</div>
                        </div>
                        <div class="target-comparison">
                            <div class="mb-2">
                                <span class="badge bg-success">Target: 85%</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-warning" role="progressbar" 
                                     style="width: 85%" id="oee-progress"></div>
                            </div>
                        </div>
                    </div>
                    <div class="oee-components d-flex gap-3">
                        <div class="text-center">
                            <div class="h4 mb-0 text-success" id="availability">92.5%</div>
                            <small>Availability</small>
                        </div>
                        <div class="text-center">
                            <div class="h4 mb-0 text-info" id="performance">89.1%</div>
                            <small>Performance</small>
                        </div>
                        <div class="text-center">
                            <div class="h4 mb-0 text-warning" id="quality">95.8%</div>
                            <small>Quality</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Team Status -->
            <div class="col-lg-4 text-center">
                <div class="team-status">
                    <div class="status-indicator mb-3">
                        <div class="status-light status-green mx-auto mb-2"></div>
                        <h4>Team Alpha - On Track!</h4>
                        <p class="mb-0">Performing above target for the shift</p>
                    </div>
                    <div class="performance-trend mt-3">
                        <canvas id="trend-chart" width="200" height="100"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Call to Action -->
            <div class="col-lg-4 text-center">
                <div class="cta-section">
                    <div class="highlight-card bg-white text-dark p-4 rounded-3 shadow">
                        <h5 class="text-primary mb-3">üèÜ Best Shift of the Week</h5>
                        <p class="mb-3">Team Bravo achieved <strong>94.2% OEE</strong> yesterday!</p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-lg" onclick="joinChallenge()">
                                <i class="fas fa-trophy me-2"></i>Join Today's Challenge
                            </button>
                            <button class="btn btn-outline-primary" onclick="viewShiftStats()">
                                <i class="fas fa-chart-line me-2"></i>View Shift Performance
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Alert Container -->
<div id="alert-container" class="container-fluid mb-3"></div>

<!-- Clean Start Message -->
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-check-circle me-2"></i>Clean Dashboard Start
                </h5>
            </div>
            <div class="card-body text-center py-5">
                <h3>OEE Dashboard Platform</h3>
                <p class="lead">All previous dashboards have been removed.</p>
                <p>Ready for fresh dashboard development from scratch.</p>
                <div class="alert alert-info">
                    <strong>Status:</strong> Clean environment ready for new dashboard implementation
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize dashboard when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
    startMetricsUpdates();
    initTrendChart();
});

// Initialize dashboard components
function initializeDashboard() {
    // Add fade-in animation to cards
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.classList.add('fade-in');
        }, index * 100);
    });
}

// Start periodic metrics updates
function startMetricsUpdates() {
    // Update immediately
    updateMetrics();
    // Then update every 5 seconds
    setInterval(updateMetrics, 5000);
}

// Update metrics from API
function updateMetrics() {
    fetch('/api/current-metrics/')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            updateOEEMetrics(data);
        })
        .catch(error => {
            console.log('Metrics update failed:', error);
        });
}

// Update OEE metrics in UI
function updateOEEMetrics(data) {
    // Safely update elements with null checks
    updateElement('current-oee', data.oee ? data.oee.toFixed(1) : '0.0');
    updateElement('availability', data.availability ? data.availability.toFixed(1) + '%' : '0.0%');
    updateElement('performance', data.performance ? data.performance.toFixed(1) + '%' : '0.0%');
    updateElement('quality', data.quality ? data.quality.toFixed(1) + '%' : '0.0%');
    
    // Update progress bar
    const progressBar = document.getElementById('oee-progress');
    if (progressBar && data.oee) {
        progressBar.style.width = data.oee + '%';
    }
}

// Safely update an element's text content
function updateElement(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = value;
    }
}

// Button functions for home page
function joinChallenge() {
    window.location.href = '/challenges/';
}

function viewShiftStats() {
    window.location.href = '/shifts/';
}

// Initialize trend chart
function initTrendChart() {
    const canvas = document.getElementById('trend-chart');
    if (!canvas) return;
    
    try {
        const ctx = canvas.getContext('2d');
        
        // Simple line drawing for trend
        ctx.strokeStyle = '#28a745';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(10, 80);
        ctx.lineTo(50, 60);
        ctx.lineTo(100, 40);
        ctx.lineTo(150, 30);
        ctx.lineTo(190, 20);
        ctx.stroke();
        
        // Add some dots
        ctx.fillStyle = '#28a745';
        [10, 50, 100, 150, 190].forEach((x, i) => {
            const y = [80, 60, 40, 30, 20][i];
            ctx.beginPath();
            ctx.arc(x, y, 3, 0, 2 * Math.PI);
            ctx.fill();
        });
    } catch (error) {
        console.log('Canvas chart initialization failed:', error);
    }
}
</script>
{% endblock %}