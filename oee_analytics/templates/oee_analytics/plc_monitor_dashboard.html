{% extends "base.html" %}

{% block title %}Real-Time PLC Monitor{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4">
                <i class="bi bi-hdd-network"></i> Real-Time PLC Monitor
            </h1>
            <p class="lead">Live data from all 12 PLC simulators</p>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total PLCs</h5>
                    <h2 id="total-plcs">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Online</h5>
                    <h2 id="online-plcs">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">Offline</h5>
                    <h2 id="offline-plcs">-</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Indicator -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info d-flex justify-content-between align-items-center" role="alert">
                <span>
                    <i class="bi bi-broadcast"></i> <strong>Live Updates:</strong>
                    <span id="status-indicator">Connecting...</span>
                </span>
                <span>
                    Last Update: <strong id="last-update">-</strong>
                </span>
            </div>
        </div>
    </div>

    <!-- PLC Cards -->
    <div id="plc-cards-container" class="row g-3">
        <!-- Cards will be dynamically inserted here -->
    </div>
</div>

<style>
.plc-card {
    transition: all 0.3s ease;
}
.plc-card.online {
    border-left: 4px solid #28a745;
}
.plc-card.offline {
    border-left: 4px solid #dc3545;
    opacity: 0.7;
}
.status-badge {
    font-size: 0.9rem;
    padding: 0.25rem 0.75rem;
}
.metric-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2c3e50;
}
.metric-label {
    font-size: 0.85rem;
    color: #6c757d;
    text-transform: uppercase;
}
.running-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 5px;
}
.running-indicator.on {
    background-color: #28a745;
    box-shadow: 0 0 5px #28a745;
}
.running-indicator.off {
    background-color: #dc3545;
    box-shadow: 0 0 5px #dc3545;
}
</style>

<script>
let eventSource = null;

function initializeStream() {
    // Close existing connection if any
    if (eventSource) {
        eventSource.close();
    }

    // Create new EventSource for SSE
    eventSource = new EventSource('{% url "plc_stream" %}');

    eventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);

            if (data.error) {
                document.getElementById('status-indicator').innerHTML =
                    '<span class="text-danger">Error: ' + data.error + '</span>';
                return;
            }

            // Update status
            document.getElementById('status-indicator').innerHTML =
                '<span class="text-success">Connected - Receiving Updates</span>';

            // Update timestamp
            const timestamp = new Date(data.timestamp);
            document.getElementById('last-update').textContent =
                timestamp.toLocaleTimeString();

            // Update summary
            document.getElementById('total-plcs').textContent = data.summary.total;
            document.getElementById('online-plcs').textContent = data.summary.online;
            document.getElementById('offline-plcs').textContent = data.summary.offline;

            // Update or create PLC cards
            updatePLCCards(data.plcs);

        } catch (e) {
            console.error('Error parsing SSE data:', e);
        }
    };

    eventSource.onerror = function(error) {
        console.error('SSE error:', error);
        document.getElementById('status-indicator').innerHTML =
            '<span class="text-warning">Connection Lost - Reconnecting...</span>';

        // Reconnect after 5 seconds
        setTimeout(() => {
            initializeStream();
        }, 5000);
    };
}

function updatePLCCards(plcs) {
    const container = document.getElementById('plc-cards-container');

    plcs.forEach((plc, index) => {
        let cardId = 'plc-card-' + index;
        let card = document.getElementById(cardId);

        if (!card) {
            // Create new card
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4 col-xl-3';
            col.innerHTML = createPLCCardHTML(plc, cardId);
            container.appendChild(col);
        } else {
            // Update existing card
            updatePLCCardContent(card, plc);
        }
    });
}

function createPLCCardHTML(plc, cardId) {
    const statusClass = plc.status === 'online' ? 'online' : 'offline';
    const badgeClass = plc.status === 'online' ? 'bg-success' : 'bg-danger';

    return `
        <div id="${cardId}" class="card plc-card ${statusClass} h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong>${plc.line}</strong>
                <span class="badge ${badgeClass} status-badge">${plc.status.toUpperCase()}</span>
            </div>
            <div class="card-body">
                <small class="text-muted">${plc.type}</small>
                ${plc.status === 'online' ? createMetricsHTML(plc.data) : createOfflineHTML(plc.error)}
            </div>
        </div>
    `;
}

function createMetricsHTML(data) {
    const runningClass = data.running ? 'on' : 'off';
    const faultedIcon = data.faulted ? '<i class="bi bi-exclamation-triangle-fill text-warning"></i>' : '';

    return `
        <hr>
        <div class="mb-2">
            <span class="running-indicator ${runningClass}"></span>
            <strong>${data.running ? 'RUNNING' : 'STOPPED'}</strong>
            ${faultedIcon}
        </div>
        <div class="row g-2 mt-2">
            <div class="col-6">
                <div class="metric-label">Production</div>
                <div class="metric-value">${data.production_count}</div>
            </div>
            <div class="col-6">
                <div class="metric-label">OEE</div>
                <div class="metric-value">${data.oee}%</div>
            </div>
            <div class="col-6">
                <div class="metric-label">Good</div>
                <div class="metric-value">${data.good_count}</div>
            </div>
            <div class="col-6">
                <div class="metric-label">Reject</div>
                <div class="metric-value">${data.reject_count}</div>
            </div>
            <div class="col-12 mt-2">
                <small class="text-muted">
                    <strong>A:</strong> ${data.availability}% |
                    <strong>P:</strong> ${data.performance}% |
                    <strong>Q:</strong> ${data.quality}%
                </small>
            </div>
        </div>
    `;
}

function createOfflineHTML(error) {
    return `
        <hr>
        <div class="alert alert-warning mb-0">
            <small><strong>Offline</strong><br>${error || 'Unable to connect'}</small>
        </div>
    `;
}

function updatePLCCardContent(card, plc) {
    const statusClass = plc.status === 'online' ? 'online' : 'offline';
    const badgeClass = plc.status === 'online' ? 'bg-success' : 'bg-danger';

    card.className = `card plc-card ${statusClass} h-100`;
    card.querySelector('.status-badge').className = `badge ${badgeClass} status-badge`;
    card.querySelector('.status-badge').textContent = plc.status.toUpperCase();

    const cardBody = card.querySelector('.card-body');
    const contentDiv = cardBody.querySelector('hr').parentElement;

    if (plc.status === 'online') {
        contentDiv.innerHTML = '<hr>' + createMetricsHTML(plc.data);
    } else {
        contentDiv.innerHTML = '<hr>' + createOfflineHTML(plc.error);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeStream();
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (eventSource) {
        eventSource.close();
    }
});
</script>
{% endblock %}
