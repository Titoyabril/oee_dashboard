%%--------------------------------------------------------------------
%% EMQX Authorization (ACL) Configuration
%% Implements role-based access control for Sparkplug B
%%--------------------------------------------------------------------

%% Default action when no rule matches
%% deny - deny access (recommended for production)
%% allow - allow access
{acl_nomatch, deny}.

%% ACL file location
{acl_file, "/opt/emqx/etc/acl.conf"}.

%%--------------------------------------------------------------------
%% Role-Based ACL Rules
%%--------------------------------------------------------------------

%% EDGE ROLE: Edge nodes can only publish to their own namespace
%% Pattern: spBv1.0/{group_id}/{message_type}/{edge_node_id}/#
%%
%% Example client ID format: edge_SITE01-LINE01
%% This allows publishing to: spBv1.0/*/N*edge_SITE01-LINE01/*
%% This allows publishing to: spBv1.0/*/D*edge_SITE01-LINE01/*/*

{allow, {user, "edge_*"}, publish, ["spBv1.0/+/NBIRTH/edge_+", "spBv1.0/+/NDEATH/edge_+", "spBv1.0/+/NDATA/edge_+", "spBv1.0/+/NCMD/edge_+"]}.
{allow, {user, "edge_*"}, publish, ["spBv1.0/+/DBIRTH/edge_+/+", "spBv1.0/+/DDEATH/edge_+/+", "spBv1.0/+/DDATA/edge_+/+", "spBv1.0/+/DCMD/edge_+/+"]}.
{deny, {user, "edge_*"}, subscribe, ["#"]}.  % Edge cannot subscribe


%% ANALYTICS ROLE: Analytics services can only subscribe
%% Pattern: Subscribe to all Sparkplug topics but cannot publish
%%
%% Example client ID format: analytics_SERVICE_NAME

{allow, {user, "analytics_*"}, subscribe, ["spBv1.0/#"]}.
{allow, {user, "analytics_*"}, subscribe, ["$SYS/#"]}.  % System topics for monitoring
{deny, {user, "analytics_*"}, publish, ["#"]}.  % Analytics cannot publish


%% ADMIN ROLE: Full access for management
%% Pattern: Full pub/sub permissions
%%
%% Example client ID format: admin_USERNAME

{allow, {user, "admin_*"}, publish, ["#"]}.
{allow, {user, "admin_*"}, subscribe, ["#"]}.


%% SCADA HOST ROLE: SCADA systems acting as Sparkplug hosts
%% Pattern: Can subscribe to edge data and publish commands
%%
%% Example client ID format: scada_PRIMARY_HOST

{allow, {user, "scada_*"}, subscribe, ["spBv1.0/+/NBIRTH/+", "spBv1.0/+/NDEATH/+", "spBv1.0/+/NDATA/+"]}.
{allow, {user, "scada_*"}, subscribe, ["spBv1.0/+/DBIRTH/+/+", "spBv1.0/+/DDEATH/+/+", "spBv1.0/+/DDATA/+/+"]}.
{allow, {user, "scada_*"}, publish, ["spBv1.0/+/NCMD/+", "spBv1.0/+/DCMD/+/+"]}.
{allow, {user, "scada_*"}, publish, ["spBv1.0/STATE/+"]}.  % Host state messages


%% DASHBOARD ROLE: Read-only access for dashboards
%% Pattern: Subscribe-only to data topics
%%
%% Example client ID format: dashboard_OEE_PRODUCTION

{allow, {user, "dashboard_*"}, subscribe, ["spBv1.0/+/NDATA/+", "spBv1.0/+/DDATA/+/+"]}.
{allow, {user, "dashboard_*"}, subscribe, ["spBv1.0/+/NBIRTH/+", "spBv1.0/+/DBIRTH/+/+"]}.
{allow, {user, "dashboard_*"}, subscribe, ["oee/#"]}.  % OEE-specific topics
{deny, {user, "dashboard_*"}, publish, ["#"]}.  % Dashboards cannot publish


%%--------------------------------------------------------------------
%% Special System Rules
%%--------------------------------------------------------------------

%% Allow all users to publish to their client ID-based topics (for last will)
{allow, all, publish, ["clients/$clientid/lwt"]}.

%% Allow clients to subscribe to their own status topics
{allow, all, subscribe, ["clients/$clientid/#"]}.

%% Deny all access to internal system topics
{deny, all, subscribe, ["$internal/#"]}.
{deny, all, publish, ["$internal/#"]}.

%% Default deny rule (this should be last)
{deny, all, publish, ["#"]}.
{deny, all, subscribe, ["#"]}.
