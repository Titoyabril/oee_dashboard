# OEE Edge Gateway Configuration
# Generated by Ansible - DO NOT EDIT MANUALLY

# Edge Node Identity
edge:
  node_id: {{ edge_node_id }}
  site_id: {{ site_id }}
  line_id: {{ line_id }}
  environment: {{ oee_environment }}

# MQTT Sparkplug Configuration
mqtt:
  broker_host: {{ mqtt_broker_host }}
  broker_port: {{ mqtt_broker_port }}
  use_tls: {{ mqtt_use_tls | lower }}
  group_id: {{ site_id }}

  # TLS/mTLS Configuration
  tls:
    ca_cert: {{ edge_certs_dir }}/ca.crt
    client_cert: {{ edge_certs_dir }}/client.crt
    client_key: {{ edge_certs_dir }}/client.key
    verify_mode: CERT_REQUIRED
    tls_version: TLSv1.2

  # Connection Settings
  keep_alive: 60
  reconnect_delay_min: 1.0
  reconnect_delay_max: 60.0
  connection_timeout: 30

  # Message Handling
  max_queue_size: 10000
  batch_size: 100
  batch_timeout: 1.0

  # Store-and-Forward
  enable_store_forward: {{ store_forward_enabled | lower }}
  store_forward_max_size_mb: {{ store_forward_max_size_mb }}

  # Backpressure
  enable_backpressure: {{ backpressure_enabled | lower }}
  backpressure_threshold: {{ backpressure_threshold }}
  backpressure_resume_threshold: {{ backpressure_resume_threshold }}

# OPC-UA Client Configuration
opcua:
  endpoints:
{% for server in opcua_servers %}
    - url: {{ server.endpoint }}
      description: {{ server.description }}
      vendor: {{ server.vendor | default('Generic') }}
      security_mode: {{ server.security_mode | default('SignAndEncrypt') }}
      security_policy: {{ server.security_policy | default('Basic256Sha256') }}

      # Subscription Settings
      default_sampling_interval: {{ server.sampling_interval | default(250) }}
      publishing_interval: {{ server.publishing_interval | default(250) }}
      queue_size: 10
      discard_oldest: true

      # Deadband (reduce noise)
      deadband_type: {{ server.deadband_type | default(1) }}  # 1=Absolute
      deadband_value: {{ server.deadband_value | default(0.1) }}

{% if server.tags is defined %}
      # Monitored Items
      tags:
{% for tag in server.tags %}
        - node_id: {{ tag.node_id }}
          name: {{ tag.name }}
          signal_type: {{ tag.type }}
          sampling_interval: {{ tag.sampling_interval | default(server.sampling_interval) }}
          deadband: {{ tag.deadband | default(0.1) }}
{% endfor %}
{% endif %}
{% endfor %}

# Edge Cache (Store-and-Forward)
cache:
  redis_enabled: true
  redis_host: localhost
  redis_port: 6379
  redis_db: 0

  rocksdb_enabled: true
  rocksdb_path: {{ edge_data_dir }}/rocksdb

  max_queue_size: 10000
  max_memory_usage: {{ (store_forward_max_size_mb * 1024 * 1024) | int }}

# Adaptive Sampling
adaptive_sampling:
  normal_sampling_ms: 250
  backpressure_sampling_ms: 2000
  transition_delay_s: 5.0

# Logging Configuration
logging:
  level: {{ log_level }}
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

  handlers:
    - type: file
      filename: {{ edge_logs_dir }}/edge_gateway.log
      max_bytes: 10485760  # 10 MB
      backup_count: 10

    - type: syslog
      address: /dev/log
      facility: local0

# Monitoring
monitoring:
  prometheus_enabled: true
  prometheus_port: {{ prometheus_exporter_port }}
  health_check_port: {{ prometheus_exporter_port }}
  health_check_interval: {{ health_check_interval }}

# Performance Tuning
performance:
  worker_threads: 4
  io_threads: 2
  max_concurrent_opcua_reads: 100
